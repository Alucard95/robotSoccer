#include <WiFi.h>
#define DXL_BUS_SERIAL1 1  
#define DXL_BUS_SERIAL2 2  
#define DXL_BUS_SERIAL3 3  
#define ID_NUM1 1
#define ID_NUM2 2
#define CCW_Angle_Limit 8
#define GOAL_SPEED 32
#define ID_ROBOT 2

Dynamixel Dxl(DXL_BUS_SERIAL1);
int data[6];
int velLeft = 0;
int velRight = 0;

const char* ssid     = "RED";
const char* password = "PASS";
/* create a server and listen on port */
WiFiServer server(PORT);


void ValProcces(int data[]){ /*Procesa el pack*/
  
  int Pos = ((5-(2*ID_ROBOT)));
  velLeft = (int(data[Pos])-100)*1023/100;
  velRight = (int(data[Pos+1])-100)*1023/100;
  
  if (velLeft <0){
  velLeft = abs(velLeft)|0x400;
   }
  
  if (velRight>0){
    velRight = velRight|0x400;
  }
  else
  {
    velRight = abs(velRight);
  }
   
void setup()
{
    Serial.begin(115200);
    Serial.print("Connecting to ");
    Serial.println(ssid);
    /* connecting to WiFi */
    WiFi.begin(ssid, password);
    /*wait until ESP32 connect to WiFi*/
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("");
    Serial.println("WiFi connected with IP address: ");
    Serial.println(WiFi.localIP());
    /* start Server */
    server.begin();
    
     //Serial3 Serial initialize
  Dxl.begin(3);
  //AX MX RX Series
  Dxl.writeWord(ID_NUM1, CCW_Angle_Limit, 0); 
  Dxl.writeWord(ID_NUM2, CCW_Angle_Limit, 0); 
  SerialUSB.begin();  
}

void loop(){
      // when you typed any character in terminal
  while (SerialUSB.available() < 6);    // wait until a full packet has been buffered (infinite loop risk alert)
  for (int i = 0; i < 6; i++){
      data[i] = SerialUSB.read();
      
      SerialUSB.write(data[i]);
    /* listen for client */
    WiFiClient client = server.available(); 
    uint8_t data[30]; 
    if (client) {                   
      Serial.println("new client");         
      /* check client is connected */           
      while (client.connected()) {          
          if (client.available()) {
              int len = client.read(data, 30);
              if(len < 30){
                  data[len] = '\0';  
              }else {
                  data[30] = '\0';
              }    
              Serial.print("client sent: ");            
              Serial.println((char *)data); 
          }
      } 
    }
      ValProcces(data);
  Dxl.writeWord(ID_NUM1, GOAL_SPEED, velLeft); 
  Dxl.writeWord(ID_NUM2, GOAL_SPEED, velRight); 
}
